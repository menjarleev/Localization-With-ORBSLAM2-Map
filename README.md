# Localization-With-ORBSLAM2-Map
## Intro
This is a final project of EECS568(Mobile Robotics). We use particle filter to localize camera with unassociated landmark generated by ORBSLAM2. The main contribution is in ```extension``` folder while there are some modifications to the original ORBSLAM2 source file.
## Dependency
Due to the incompatablity of Sophus and g2o on Eigen version, we are not using the g2o provided by ORB_SLAM2. Please follow the order to install the dependencies.
```
Eigen3.3.2 // this is required by Sophus and g2o and Pangolin
gflags // this is required by fmt
glog // this is required by fmt
fmt // this is required by Sophus
Sophus
g2o
Pangolin
```
**remark: we use [g2o_20170730](https://github.com/RainerKuemmerle/g2o/releases/tag/20170730_git) and [Eigen3.3.2](https://gitlab.com/libeigen/eigen/-/releases/3.3.2)**

## Build
1. Make sure you have ```C++17``` in your PC
2. In ```CMakeLists.txt```, modify ```set(G2O_INCLUDE_DIRS "/usr/local/include/g2o")``` to wherever you have g2o header. Modify ```SET(Sophus_INCLUDE_DIR "usr/local/include/sophus")``` to wherever you have sophus header.
3. run ```./build.sh ```
remark: if you want your program to run faster, go ```CMakeLists.txt```, change
```CMake
set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS}  -Wall  -O0 -march=native ")
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall   -O0 -march=native")
```
to
```CMake
set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS}  -Wall  -O3 -march=native ")
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall   -O3 -march=native")
```
This make compiler optimize more for your code but you cannot debug in this mode.

## Map Generation
1. go to base folder.

2. run
```bash
./extension/mapsaver path_to_vocabulary path_to_settings path_to_sequence map_file
```
```path_to_vocabulary``` contains precomputed BOW, the path is always ```Vocabulary/ORBvoc.txt```.

 ```path_to_settings``` is the setting of ORB_SLAM2, which contains intrinsic camera parameter, number of features generated, etc. It's stored in ```extension/config/KITTIxxxx.yaml```. Here, ```xxxx``` represents the sequence number. For kitti dataset with sequence ```00, 01, 02```, you may want to use ```KITTI00-02.yaml```.

 ```path_to_sequence``` is the path where you store the sequence data, for example, ```/data/dataset/sequences/00```.

 ```map_file``` is your map file name that is going to be saved, like ```map00.bin```, which represents the map for sequence 00


3. Now you should have a map like ```map00.bin``` stored in the base folder.

## Localization
1. go to base folder
2. You need to modify ```GlobalVariable.cc```. If you want to do some hyper-parameter tuning, you might want to change other variables in this file. Remeber covariance of pose is initialized at ```extension/src/Localization.cc``` for the reason that Eigen3.3.2 does not support initialization at declaration.
3. run
```bash
./extension/localization path_to_vocabulary path_to_settings path_to_sequence map_file path_to_motion pose_save_path
```

```path_to_vocabulary```, ```path_to_settings```, ```path_to_sequence```, ```mapfile``` are described above.

 ```path_to_motion``` is the transformation matrix file generated by DSO, for example ```/data/motion/result_seq_00.txt```.

 ```pose_save_path``` is the file name you want your generated transformation file to be. Please give it some meaningful name, like ```pose_seq_00_P_100_Pcov_1000_Mcov_0.1.txt```, which represents this pose is for KITTI sequence 00, we have 100 particles, and the covariance for intial pose is 1000. The motion covariance hyper parameter alpha is 0.1.

 4. Now you should have a pose file that you can do evaluation with.